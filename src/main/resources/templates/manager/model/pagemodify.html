<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity3">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <!-- Meta, title, CSS, favicons, etc. -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>website manager</title>

    <!-- Bootstrap -->
    <link th:href="@{bootstrap/dist/css/bootstrap.min.css}" rel="stylesheet">
    <!-- Font Awesome -->
    <link th:href="@{font-awesome/css/font-awesome.min.css}" rel="stylesheet">
    <!-- Custom Theme Style -->
    <link th:href="@{custom/css/custom.min.css}" rel="stylesheet">
  </head>
  <body class="nav-md">
    <div class="container body">
      <div class="main_container">
        <div class="col-md-3 left_col">


            <!-- sidebar menu -->
            <!-- 嵌入菜单页面-->
            <div th:replace="manager/partial/sidebarMenu :: sidebarmenu">
            </div>
            <!-- /sidebar menu -->

          </div>
      <!-- top navigation -->
          <div th:replace="manager/partial/navigation :: navigation">
          </div>
      <!-- /top navigation -->
        </div>
        <!-- page content -->
        <div class="right_col" role="main">
          <div class="">
            <div class="clearfix"></div>
            <div class="row">
              <div class="col-md-12 col-sm-12 col-xs-12">
                <div class="x_panel">
                  <div class="x_title">
                    <h2>添加页面 </h2>
                    <ul class="nav navbar-right panel_toolbox">
                      <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                      </li>
                      <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false"><i class="fa fa-wrench"></i></a>
                        <!--<ul class="dropdown-menu" role="menu">-->
                          <!--<li><a href="#">Settings 1</a>-->
                          <!--</li>-->
                          <!--<li><a href="#">Settings 2</a>-->
                          <!--</li>-->
                        <!--</ul>-->
                      </li>
                      <!--<li><a class="close-link"><i class="fa fa-close"></i></a>-->
                      </li>
                    </ul>
                    <div class="clearfix"></div>
                  </div>
                  <div class="x_content">
                    <br />
                    <form id="html-form" data-parsley-validate class="form-horizontal form-label-left">
                      <input type="hidden" id="id" name="id" />
                      <div class="form-group">
                        <label class="control-label col-md-3 col-sm-3 col-xs-12">页面标题 :</label>
                        <div class="col-md-9 col-sm-9 col-xs-12">
                          <select class="form-control" style="width: 50%" id="title" name="title">
                            <option>--请选出--</option>
                          </select>
                        </div>
                      </div>
                      <div class="form-group">
                        <label for="htmlState" class="control-label col-md-3 col-sm-3 col-xs-12">页面类型</label>
                        <div class="col-md-9 col-sm-9 col-xs-12">
                          <select class="form-control" style="width: 50%" id="htmlState" name="htmlState">
                            <option value="0">普通模型</option>
                            <option value="1">系统模型</option>
                          </select>
                        </div>
                      </div>
                      <div class="form-group">
                        <label class="control-label col-md-3 col-sm-3 col-xs-12" for="htmlDesc">页面描述<span class="required">*</span>
                        </label>
                        <div class="col-md-6 col-sm-6 col-xs-12">
                        <textarea id="htmlDesc" required="required" class="form-control" name="htmlDesc" data-parsley-trigger="keyup" data-parsley-minlength="20" data-parsley-maxlength="100" data-parsley-minlength-message="Come on! You need to enter at least a 20 caracters long comment.."
                                  data-parsley-validation-threshold="10"></textarea>
                        </div>
                      </div>
                      <div class="ln_solid"></div>
                      <div class="form-group">
                        <label for="summernote" class="control-label col-md-3 col-sm-3 col-xs-12">内容</label>
                        <div id="summernote" name="summernote"></div>
                      </div>
                      <div class="ln_solid"></div>
                      <div class="form-group">
                        <div class="col-md-9 col-md-offset-5">
                            <button type="button" class="btn btn-primary">取消</button>
                            <button type="reset" class="btn btn-primary">重置</button>
                            <button type="submit" class="btn btn-success" onclick="modifyPage()">提交</button>
                        </div>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- /page content -->
        <!-- footer content -->
      <div th:replace="manager/partial/footer :: footer">
        <!-- /footer content -->
      </div>
    </div>
    <!-- jQuery -->
    <script th:src="@{js/jquery.min.js}"></script>
    <!-- Bootstrap -->
    <script th:src="@{bootstrap/dist/js/bootstrap.min.js}"></script>
    <!-- FastClick 快速单击插件-->
    <script th:src="@{fastclick/lib/fastclick.js}"></script>
    <!-- Custom Theme Scripts -->
    <script th:src="@{custom/js/custom.min.js}"></script>
    <!--summernote插件-->
    <link th:href="@{summernote/summernote.css}" rel="stylesheet">
    <script th:src="@{summernote/summernote.js}"></script>
    <script th:src="@{js/tools.js}"></script>
    <script th:inline="javascript">
        $(document).ready(function () {
            initMenuState();
            var url =getRootPath()+"/page/uploadImage";
            $('#summernote').summernote({
                lang:'zh-cn',
                toolbar: [
                    ['style', ['style']],
                    ['font', ['bold', 'underline', 'clear']],
                    ['fontsize', ['fontsize']],
                    ['fontname', ['fontname']],
                    ['color', ['color']],
                    ['para', ['ul', 'ol', 'paragraph']],
                    ['table', ['table']],
                    ['insert', ['link', 'picture']],
                    ['view', ['fullscreen', 'codeview', 'help']]
                ],
                // popover
                popover: {
                    image: [
                        ['imagesize', ['imageSize100', 'imageSize50', 'imageSize25']],
                        ['float', ['floatLeft', 'floatRight', 'floatNone']],
                        ['remove', ['removeMedia']]
                    ],
                    link: [
                        ['link', ['linkDialogShow', 'unlink']]
                    ],
                    air: [
                        ['color', ['color']],
                        ['font', ['bold', 'underline', 'clear']],
                        ['para', ['ul', 'paragraph']],
                        ['table', ['table']],
                        ['insert', ['link', 'picture']]
                    ]
                },
                height: 500,
                width:200,
                fontNames: ['Arial', 'Arial Black', 'Comic Sans MS', 'Courier New','Impact','Lucida Grande','Tahoma','Times New Roman','Verdana','宋体'],
                callbacks: {
                    onImageUpload: function(files) {
                        //上传图片到服务器，使用了formData对象，至于兼容性...据说对低版本IE不太友好
                        var formData = new FormData();
                        formData.append('file',files[0]);
                        $.ajax({
                            url : url,//后台文件上传接口
                            type : 'POST',
                            data : formData,
                            processData : false,
                            contentType : false,
                            success : function(data) {
                                $('#summernote').summernote('insertImage',data,'img');
                            }
                        });
                    }
                }
            });


            pageList();
        });
        function pageList() {
            var url = getRootPath()+"/page/getHtmlList";
            $.ajax({
                type:"post",
                url:url,
                dataType:"json",
                success:function(data) {
                    var array =data.data;
                    $.each(array,function (index,n) {
                        console.log(n.id);
                        console.log("<option value="+n.title+" pageid="+n.id+">"+n.title+"</option>");
                        $("#title").append("<option value="+n.title+" pageid="+n.id+">"+n.title+"</option>");
                    })
                },
                error:function (data) {
                    var array =data.data;
                    $.each(array,function (index,n) {
                        $("#title").append("<option value="+n.title+" pageid="+n.id+">"+n.title+"</option>");
                    })
                    alert("操作信息。"+data.msg);
                }
            });
        }
        $("#title").change(function(){
            var id =$('#title option:selected').attr("pageid");
            if(id == null || id == undefined){
                return;
            }
            var url = getRootPath()+"/page/getContentById";
            $.ajax({
                type:"post",
                url:url,
                dataType:"json",
                data:{"id":id},
                success:function(data) {
                    console.log(data.data);
                    $('#summernote').summernote('code', data.data.content);
                    $('#htmlState').val(data.data.htmlState);
                    $('#htmlDesc').val(data.data.htmlDesc);
                    $('#id').val(data.data.id);

                },
                error:function (data) {
                    console.log("fail");
                    alert("操作信息。"+data.msg);
                }
            });
        });
        function modifyPage() {
            var markupStr = $('#summernote').summernote('code');
            var url = getRootPath()+"/page/modifyPage";
            var formData = new FormData(document.getElementById("html-form"));
            formData.append('content', markupStr);
           console.log( formData.toString());
            $.ajax({
                url: url,
                type: 'POST',
                cache: false,
                data: formData,
                processData: false,
                contentType: false,
                async:false
            }).done(function(res) {
                alert("操作信息："+res.msg);
                console.log("done");

            }).fail(function(res) {
                console.log("fail");
                alert("操作信息："+res.msg);
            });
        }
        function initMenuState() {
            var menuState =[[${#httpSession.getAttribute('menuState')}]];
            if(menuState != null){
                $('body').attr('class',menuState);
            }
        }
    </script>
  </body>
</html>
